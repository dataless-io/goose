<!DOCTYPE html>
<html>
<head>
    <title>Goose</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>

    <div style="float: right;">
        <div id="logout" style="display:none;">
            <img id="user_picture" src="" style="border-radius: 50%; height: 32px; vertical-align: middle;">
            <span id="user_nick" style="font-weight: bold;"></span>
            <a href="/auth/logout">Logout</a>
        </div>
    </div>
    <br><br>

    <div class="center" style="max-width: 600px; margin: 0 auto;">

        <div id="loggoose" style="text-align: center; display: none;">
            <img src="logo-small.png" alt="loggoose" style="height: 64px; vertical-align: -14px;">
            &nbsp;&nbsp;&nbsp;&nbsp;
            <span style="font-weight: bold; font-size: 50px;">Goose</span>
        </div>

        <div id="welcome" class="welcome">
            <h1>Welcome to Goose!!!</h1>

            <div style="text-align: center;">
                <img src="logo-200.jpg" alt="loggoose" style="width: 100%; max-width: 200px;"><br>
                Entra a Goose y disfruta!<br>
                <br>
                <a href="/auth/login" class="button-login">Entra</a>
            </div>

        </div>

        <div id="publish" class="publish">
        <textarea
                id="input-publish"
                rows="3"
                style="width: 100%; box-sizing: border-box;"
                autofocus
        ></textarea>
            <div style="text-align: right;">
                <button id="button-publish">Publicar üê§</button>
            </div>
        </div>

        <div id="timeline" class="timeline">

        </div>
    </div>


    <style>
        html {
            font-family: sans-serif;
        }

        .tweet {
            border: solid silver 1px;
            border-radius: 8px;
            padding: 8px;
            margin: 8px;
        }

        .tweet .author {
            float: right;
        }

        .tweet .date {
            font-size: 70%;
            color: rgb(104, 144, 197);
        }

        .timeline {
            display: none;
            margin: 16px auto;
        }

        .publish {
            display: none;
            border: solid silver 1px;
            border-radius: 8px;
            padding: 8px;
            margin: 8px;
        }

        .button-login {
            display: inline-block;
            border-radius: 3px;
            padding: 0.8rem 4rem;
            border: none;
            font-size: 1rem;
            cursor: pointer;
            color: white;
            background-color: #f57f56;
            font-weight: bold;
            text-decoration: none;
            margin: 1rem 0;
        }
    </style>

    <script>

        var user = {};

        function id(s) {
            return document.getElementById(s);
        }

        id('button-publish').addEventListener('click', function () {
            let input = id('input-publish');
            let body = {
                message: input.value,
            };
            fetch('/v0/publish', {method:'POST', body:JSON.stringify(body), headers: {'X-Glue-Authentication':' {"user":{"id":"user-12"}}'}})
                .then(resp => resp.json()).then(entry => {
                    if (entry.error) {
                        alert(entry.error.message);
                        return
                    }

                    prependTweet(entry);
                    input.value = '';
                });
        });

        function fetchTimeline(userid) {
            const url = '/v0/users/'+encodeURIComponent(userid)+"/timeline";
            fetch(url)
                .then((response) => response.text())
                .then((text) => {
                    text
                        .split("\n")
                        .forEach(line => {
                            let entry = JSON.parse(line);
                            prependTweet(entry);
                        });
                });
        }

        fetch('/auth/me').then(resp => resp.json()).then(me => {
            if (me.error) return;
            user = me;
            id('welcome').style.display = 'none';
            id('loggoose').style.display = 'block';
            id('logout').style.display = 'block';
            id('publish').style.display = 'block';
            id('timeline').style.display = 'block';
            id('user_picture').setAttribute('src', me.picture);
            id('user_nick').innerText = me.nick;
            fetchTimeline(me.id);
        });

        function paintTweet(entry) {
            let tweet = document.createElement('div');
            tweet.classList.add('tweet');
            tweet.id = entry.id;

            let author = document.createElement('div');
            author.classList.add('author');
            author.textContent = '@' + entry.user_id;
            tweet.appendChild(author);

            let date = document.createElement('div');
            date.classList.add('date');
            date.textContent = (new Date(1000*entry.timestamp)).toLocaleString();
            tweet.appendChild(date);

            let message = document.createElement('div');
            message.textContent = entry.message;
            tweet.appendChild(message);

            return tweet;
        }

        function appendTweet(entry) {
            let tweet = paintTweet(entry);
            id('timeline').appendChild(tweet);
        }

        function prependTweet(entry) {
            let tweet = paintTweet(entry);
            id('timeline').prepend(tweet);
        }

    </script>
</body>
</html>


